<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Heart Rate Car Controller — Random Trees</title>
  <style>
    :root{
      --sky1:#87CEEB;
      --sky2:#98D8C8;
      --road:#333;
      --lane:#fff;

      /* Night mode controls */
      --sceneDarken: 0;           /* 0 (day) → 0.35 (night) */
      --beamOpacity: 0;           /* 0 (off) → 0.9 (on) */

      /* Road dash duration (will be updated by JS) */
      --dashDur: 1.3s;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      height:100vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* Game Area */
    .game-area{
      flex:1;
      position:relative;
      background: linear-gradient(to bottom, var(--sky1) 0%, var(--sky2) 100%);
      overflow:hidden;
      filter: brightness(calc(1 - var(--sceneDarken)));
      transition: filter .3s ease;
    }

    /* ---------- SCENERY: seamless, two identical panels ---------- */
    .layer{
      position:absolute; inset:0;
      display:flex; width:200%; height:100%;
      pointer-events:none;
    }
    .layer .panel{ position:relative; width:50%; height:100%; }

    /* ===== Clouds (detailed) ===== */
    .clouds{ animation:cloudScroll 45s linear infinite; opacity:.92; }
    @keyframes cloudScroll{ 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
    .cloud{
      position:absolute;
      --cw: 120px; --ch: 54px;
      width: var(--cw); height: var(--ch);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.08));
      animation: cloudFloat 6.5s ease-in-out infinite, cloudMorph 9s ease-in-out infinite;
      transform-origin: 50% 60%;
    }
    .cloud::before{
      content:""; position:absolute; inset:0; border-radius:40px;
      background:
        radial-gradient(120% 120% at 50% 60%, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(60% 70% at 45% 55%, #ffffff 0 55%, rgba(255,255,255,.0) 56%),
        radial-gradient(42% 48% at 28% 62%, #ffffff 0 60%, rgba(255,255,255,0) 61%),
        radial-gradient(45% 50% at 70% 50%, #ffffff 0 60%, rgba(255,255,255,0) 61%),
        radial-gradient(40% 40% at 52% 32%, #ffffff 0 60%, rgba(255,255,255,0) 61%);
      mask: radial-gradient(120% 120% at 50% 60%, #000 0 60%, transparent 61%);
    }
    .cloud::after{
      content:""; position:absolute; inset:0;
      background: radial-gradient(120% 100% at 50% 100%, rgba(0,0,0,.08), rgba(0,0,0,0) 60%);
      pointer-events:none;
    }
    @keyframes cloudFloat{ 0%,100%{ transform: translateY(0) } 50%{ transform: translateY(-4px) } }
    @keyframes cloudMorph{ 0%,100%{ border-radius: 40px } 50%{ border-radius: 46px } }

    /* ===== Trees (detailed) ===== */
    .trees{ animation:treeScroll 18s linear infinite; }
    @keyframes treeScroll{ 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

    .tree{
      position:absolute; bottom:200px;
      --ts: 1;
      width: calc(70px * var(--ts));
      height: calc(110px * var(--ts));
      animation: treeSway 3.8s ease-in-out infinite;
      transform-origin: 50% 100%;
    }
    .tree::before{
      content:""; position:absolute; left:50%; transform:translateX(-50%);
      bottom: 24px; width: 100%; height: 86%;
      border-radius: 50% 50% 40% 40%;
      background:
        radial-gradient(120% 100% at 30% 30%, rgba(255,255,255,.12), rgba(255,255,255,0) 55%),
        radial-gradient(70% 70% at 55% 35%, #2fcf6e 0 60%, rgba(0,0,0,0) 61%),
        radial-gradient(70% 70% at 28% 56%, #2dbf66 0 60%, rgba(0,0,0,0) 61%),
        radial-gradient(70% 70% at 72% 56%, #30b861 0 60%, rgba(0,0,0,0) 61%),
        radial-gradient(85% 80% at 50% 58%, #29a85a 0 70%, rgba(0,0,0,0) 71%);
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.12));
    }
    .tree::after{
      content:""; position:absolute; left:50%; transform:translateX(-50%);
      bottom:0; width: calc(16px * var(--ts)); height: calc(28px * var(--ts));
      border-radius: 4px;
      background:
        linear-gradient(90deg, rgba(0,0,0,.18), rgba(0,0,0,0) 25%, rgba(0,0,0,0) 75%, rgba(0,0,0,.18)),
        repeating-linear-gradient(180deg, rgba(255,255,255,.06) 0 2px, rgba(0,0,0,0) 2px 6px),
        #8b6239;
      box-shadow: 0 2px 0 rgba(0,0,0,.15);
    }
    .tree > i{
      position:absolute; content:""; display:block;
      left:50%; bottom:-8px; transform:translateX(-50%);
      width: calc(64px * var(--ts)); height: 10px; border-radius:50%;
      background: radial-gradient(closest-side, rgba(0,0,0,.18), rgba(0,0,0,0));
      pointer-events:none;
    }
    @keyframes treeSway{ 0%,100%{ transform: rotate(-1deg) } 50%{ transform: rotate(1.6deg) } }

    /* ---------- ROAD ---------- */
    .road{
      position:absolute; left:0; right:0; bottom:0; height:200px;
      background: var(--road);
      overflow:hidden;
      animation-play-state: running;
    }
    .road::before{
      content:""; position:absolute; left:0; right:0; top:50%; height:8px; transform:translateY(-50%);
      background: repeating-linear-gradient(90deg, var(--lane) 0 60px, transparent 60px 120px);
      animation:dashScroll var(--dashDur) linear infinite;
      opacity:.95;
    }
    @keyframes dashScroll{ 0%{background-position-x:0} 100%{background-position-x:-120px} }

    /* ---------- Speed lines ---------- */
    .speed-lines{position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .25s;}
    .speed-line{
      position:absolute; left:0; right:0; height:2px;
      background:linear-gradient(to right,transparent,rgba(255,255,255,.85),transparent);
      animation:speedLine .25s linear infinite;
    }
    .speed-line:nth-child(1){top:22%}
    .speed-line:nth-child(2){top:42%}
    .speed-line:nth-child(3){top:62%}
    .speed-line:nth-child(4){top:82%}
    @keyframes speedLine{ 0%{transform:translateX(100%)} 100%{transform:translateX(-100%)} }

    /* ---------- Car (unchanged styling) ---------- */
    .car{
      position:absolute; bottom:50px; left:50%; transform:translateX(-50%);
      width:80px; height:40px; z-index:10;
      transition:bottom .3s ease, transform .3s ease;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.35));
    }
    .car-body{
      position:relative; width:100%; height:100%;
      background:#e74c3c; border-radius:10px;
      box-shadow:0 5px 12px rgba(0,0,0,.35);
    }
    .car-body::before{
      content:""; position:absolute; top:-15px; left:15px; width:50px; height:20px;
      background:#c0392b; border-radius:5px 5px 0 0;
    }
    .beams{
      position:absolute; right: -50px; top:-3px;
      width:56px; height:40px; pointer-events:none;
      background: radial-gradient(ellipse at right,
                rgba(210,235,255,var(--beamOpacity)) 0%,
                rgba(210,235,255,0) 75%);
      transform: translateX(20px) scaleX(2.0);
    }
    .exhaust{ position:absolute; left:-6px; bottom:4px; width:0; height:0; overflow:visible; pointer-events:none; }
    .puff{
      position:absolute; width:10px; height:6px; border-radius:50%;
      background: radial-gradient(circle at 40% 50%, rgba(200,200,200,.9), rgba(200,200,200,0));
      opacity:.85; filter: blur(.3px); animation: puffMove .6s ease-out forwards;
    }
    @keyframes puffMove{
      0%{ transform: translateX(0) translateY(0) scale(.8); opacity:.8; }
      100%{ transform: translateX(-42px) translateY(-6px) scale(1.6); opacity:0; }
    }

    .wheel{
      position:absolute; bottom:-8px; width:22px; height:22px; border-radius:50%;
      background:#0f0f0f; z-index:2;
      animation:wheelSpin .5s linear infinite;
      box-shadow: inset 0 0 6px rgba(255,255,255,.06), inset 0 -1px 4px rgba(0,0,0,.65);
    }
    .wheel.front{ left:10px }
    .wheel.rear { right:10px }
    .wheel .rim{
      position:absolute; inset:3px; border-radius:50%;
      background:
        radial-gradient(circle at 50% 50%, #bbb 0 2px, transparent 2px),
        conic-gradient(from 0deg,
          #dedede 0 12%, #676767 12% 24%,
          #dedede 24% 36%, #676767 36% 48%,
          #dedede 48% 60%, #676767 60% 72%,
          #dedede 72% 84%, #676767 84% 100%);
      filter: drop-shadow(0 0 1px rgba(0,0,0,.6));
    }
    @keyframes wheelSpin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* ---------- UI ---------- */
    .control-panel{
      background: rgba(0,0,0,.92);
      padding:18px;
      display:flex; gap:20px; justify-content:space-around; align-items:center;
      box-shadow:0 -6px 22px rgba(0,0,0,.4);
    }
    .heart-monitor{display:flex; flex-direction:column; align-items:center; color:#fff;}
    .heart-icon{font-size:40px; color:#e74c3c; animation:heartbeat 1s ease-in-out infinite;}
    @keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .heart-rate-display{font-size:36px; font-weight:700; color:#e74c3c; margin:10px 0; text-shadow:0 0 10px rgba(231,76,60,.5);}
    .heart-rate-label{font-size:14px; color:#95a5a6;}

    .slider-container{display:flex; flex-direction:column; align-items:center; gap:10px;}
    .slider-label{color:#fff; font-size:14px;}
    .heart-slider{width:220px; height:8px; appearance:none; background:linear-gradient(90deg,#3498db 0%,#e74c3c 100%); border-radius:6px;}
    .heart-slider::-webkit-slider-thumb{
      appearance:none; width:26px; height:26px; border-radius:50%; background:#fff; border:3px solid #e74c3c;
      box-shadow:0 2px 5px rgba(0,0,0,.3); cursor:pointer;
    }

    .controls{display:flex; gap:14px; align-items:center;}
    .control-btn{
      width:54px; height:54px; border:0; border-radius:12px; cursor:pointer;
      display:flex; align-items:center; justify-content:center; font-size:22px; color:#fff; background:#3b4a63;
      box-shadow:0 4px 6px rgba(0,0,0,.3); transition:transform .15s, background .15s;
    }
    .control-btn:hover{transform:translateY(-2px); background:#2f3e56;}
    .control-btn:active{transform:translateY(0);}

    .toggle{
      padding:10px 14px; border-radius:10px; border:0; cursor:pointer; color:#111; background:#e6f0ff; font-weight:700;
    }

    .speed-display{color:#fff; text-align:center;}
    .speed-value{font-size:28px; font-weight:700; color:#3aa0ff;}
    .speed-label{font-size:14px; color:#95a5a6;}

    .instructions{
      position:absolute; top:16px; left:50%; transform:translateX(-50%);
      background: rgba(0,0,0,.72); color:#fff; padding:10px 18px;
      border-radius:10px; text-align:center; z-index:100;
    }

    /* High-speed shake preserved */
    @keyframes carShake{
      0%,100%{transform:translateX(-50%) translateY(0)}
      50%{transform:translateX(-50%) translateY(-2px)}
    }
  </style>
</head>
<body>
  <div class="game-area">
    <div class="instructions">
      <p> Adjust Heart Rate | Arrow Keys steer | Press <b>N</b> or click Night Mode</p>
    </div>

    <!-- Parallax layers -->
    <div class="layer clouds">
      <div class="panel">
        <div class="cloud" style="left:120px; top:44px;"></div>
        <div class="cloud" style="--cw:140px; --ch:60px; left:440px; top:62px;"></div>
        <div class="cloud" style="--cw:130px; --ch:56px; left:780px; top:40px;"></div>
      </div>
      <div class="panel">
        <div class="cloud" style="left:120px; top:44px;"></div>
        <div class="cloud" style="--cw:140px; --ch:60px; left:440px; top:62px;"></div>
        <div class="cloud" style="--cw:130px; --ch:56px; left:780px; top:40px;"></div>
      </div>
    </div>

    <!-- Trees layer (panels start EMPTY; JS will fill with random trees) -->
    <div class="layer trees" id="treesLayer">
      <div class="panel" id="treesA"></div>
      <div class="panel" id="treesB"></div>
    </div>

    <!-- Speed lines -->
    <div class="speed-lines" id="speedLines">
      <div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div><div class="speed-line"></div>
    </div>

    <!-- Road -->
    <div class="road"></div>

    <!-- Car -->
    <div class="car" id="car">
      <div class="car-body">
        <div class="beams"></div>
        <div class="exhaust" id="exhaust"></div>
      </div>
      <div class="wheel front"><div class="rim"></div></div>
      <div class="wheel rear"><div class="rim"></div></div>
    </div>
  </div>

  <div class="control-panel">
    <div class="heart-monitor">
      <div class="heart-icon">❤️</div>
      <div class="heart-rate-display" id="heartRateDisplay">60</div>
      <div class="heart-rate-label">BPM</div>
    </div>

    <div class="slider-container">
      <label class="slider-label">Adjust Heart Rate</label>
      <input type="range" class="heart-slider" id="heartSlider" min="40" max="180" value="60">
    </div>

    <div class="controls">
      <button class="control-btn" onclick="moveCar('up')">↑</button>
      <div>
        <button class="control-btn" onclick="moveCar('left')">←</button>
        <button class="control-btn" onclick="moveCar('right')">→</button>
      </div>
      <button class="control-btn" onclick="moveCar('down')">↓</button>
    </div>

    <button class="toggle" id="nightBtn">Night Mode</button>

    <div class="speed-display">
      <div class="speed-value" id="speedDisplay">0</div>
      <div class="speed-label">MPH</div>
    </div>
  </div>

  <script>
    let heartRate = 60;
    let speed = 0;

    const car = document.getElementById('car');
    const heartSlider = document.getElementById('heartSlider');
    const heartRateDisplay = document.getElementById('heartRateDisplay');
    const speedDisplay = document.getElementById('speedDisplay');
    const speedLines = document.getElementById('speedLines');
    const wheels = document.querySelectorAll('.wheel');
    const heartIcon = document.querySelector('.heart-icon');
    const nightBtn = document.getElementById('nightBtn');
    const exhaust = document.getElementById('exhaust');

    // layers we scale by speed
    const clouds = document.querySelector('.clouds');
    const treesLayer = document.getElementById('treesLayer');
    const road   = document.querySelector('.road');

    // tree panels to populate
    const treesA = document.getElementById('treesA');
    const treesB = document.getElementById('treesB');

    let night = false;

    function toggleNight(){
      night = !night;
      document.documentElement.style.setProperty('--beamOpacity', night ? 0.9 : 0);
      document.documentElement.style.setProperty('--sceneDarken', night ? 0.35 : 0);
      nightBtn.textContent = night ? 'Day Mode' : 'Night Mode';
    }
    nightBtn.addEventListener('click', toggleNight);
    document.addEventListener('keydown', e => {
      if (e.key === 'n' || e.key === 'N') toggleNight();
    });

    /* ----- RANDOM TREE GENERATOR ----- */
    function randomRange(min, max){ return Math.random() * (max - min) + min; }

    function buildRandomTrees(panel, panelWidth){
      panel.innerHTML = '';
      // number of trees per panel: random 5..9 (feel free to tweak)
      const count = Math.floor(randomRange(5, 10));

      // generate candidate x positions then sort so they don't overlap weirdly
      const xs = [];
      for (let i=0; i<count; i++){
        // keep them inside the panel: add margins so trunks don't get cut at edges
        xs.push(randomRange(40, panelWidth - 100));
      }
      xs.sort((a,b)=>a-b);

      for (let i=0; i<count; i++){
        const t = document.createElement('div');
        t.className = 'tree';
        const scale = randomRange(0.85, 1.25);          // varied heights
        const jitterY = randomRange(-6, 6);             // slight vertical variety
        const x = xs[i] + randomRange(-12, 12);         // small x jitter per bucket
        t.style.setProperty('--ts', scale.toFixed(2));
        t.style.left = x + 'px';
        t.style.bottom = (200 + jitterY) + 'px';
        // ground shadow child
        const shadow = document.createElement('i');
        t.appendChild(shadow);
        panel.appendChild(t);
      }
    }

    function generateTreePanels(){
      // Each panel is 50% width of the layer; layer spans 200% of viewport width,
      // but each panel visually matches the viewport width. Use current viewport width.
      const panelWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      buildRandomTrees(treesA, panelWidth);
      // For seamless tiling, clone A into B
      treesB.innerHTML = treesA.innerHTML;
    }

    window.addEventListener('resize', () => {
      // Rebuild trees on resize so spacing stays nice
      generateTreePanels();
    });

    heartSlider.addEventListener('input', (e) => {
      heartRate = parseInt(e.target.value, 10);
      updateHeartRate();
    });

    function updateHeartRate(){
      heartRateDisplay.textContent = heartRate;

      // Map 40..180 BPM to 0..140 MPH
      speed = Math.max(0, Math.round(((heartRate - 40) / 140) * 140));
      speedDisplay.textContent = speed;

      // Scale parallax and dashes by speed
      const factor = (speed / 20 + 1);                // ~1..8+
      const cloudsDur = Math.max(8, 45 / factor);     // seconds
      const treesDur  = Math.max(4, 18 / factor);     // seconds
      const dashDur   = Math.max(0.35, 1.3 / (speed/60 + 0.4)); // seconds

      clouds.style.animationDuration = cloudsDur + 's';
      treesLayer.style.animationDuration = treesDur  + 's';
      document.documentElement.style.setProperty('--dashDur', dashDur + 's');

      // Pause/Run by speed
      const play = speed > 0 ? 'running' : 'paused';
      clouds.style.animationPlayState    = play;
      treesLayer.style.animationPlayState= play;
      road.style.animationPlayState      = play;

      // Wheel spin rate
      wheels.forEach(w => {
        if (speed > 0){
          w.style.animationDuration = (0.5 / (speed / 60 + 0.1)) + 's';
          w.style.animationPlayState = 'running';
        } else {
          w.style.animationPlayState = 'paused';
        }
      });

      // Heartbeat tempo
      heartIcon.style.animationDuration = (60 / Math.max(heartRate, 1)) + 's';

      // Speed lines intensity
      speedLines.style.opacity = speed > 80 ? (speed - 80) / 60 : 0;

      // Exhaust smoke when > 70 mph
      if (speed > 70) spawnPuff();

      // Car vibration at high speed
      if (speed > 110){
        car.style.animation = 'carShake .1s infinite';
      } else {
        car.style.animation = 'none';
      }
    }

    function spawnPuff(){
      const count = speed > 120 ? 2 : 1;
      for (let i=0; i<count; i++){
        const p = document.createElement('div');
        p.className = 'puff';
        p.style.left = (Math.random()*6 - 3) + 'px';
        p.style.bottom = (Math.random()*4 - 2) + 'px';
        exhaust.appendChild(p);
        setTimeout(() => p.remove(), 600);
      }
    }

    function moveCar(direction){
      const currentLeft = parseInt((car.style.left || '50').replace('%',''), 10);
      const currentBottom = parseInt((car.style.bottom || '50').replace('px',''), 10);

      switch(direction){
        case 'up':    car.style.bottom = Math.min(150, currentBottom + 20) + 'px'; break;
        case 'down':  car.style.bottom = Math.max(30,  currentBottom - 20) + 'px'; break;
        case 'left':  car.style.left   = Math.max(20,  currentLeft - 5)  + '%';    break;
        case 'right': car.style.left   = Math.min(80,  currentLeft + 5)  + '%';    break;
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp')    moveCar('up');
      if (e.key === 'ArrowDown')  moveCar('down');
      if (e.key === 'ArrowLeft')  moveCar('left');
      if (e.key === 'ArrowRight') moveCar('right');
    });

    // Initialize
    generateTreePanels();
    updateHeartRate();
  </script>
</body>
</html>
